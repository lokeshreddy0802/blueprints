{"status":{},"spec":{"name":"MultiVM-RHEL8","description":"","resources":{"service_definition_list":[{"name":"vm","description":"","variable_list":[{"type":"LOCAL","name":"CPU_COUNT","description":"","regex":{"value":"^[\\d]*$","should_validate":false},"options":{"type":"PREDEFINED","choices":[]},"is_hidden":false,"is_mandatory":false,"data_type":"BASE","val_type":"INT","label":"","attrs":{"type":""},"value":""}],"action_list":[{"type":"system","name":"action_create","description":"System action for creating an application","runbook":{"name":"e0ed6f5d_runbook","description":"","task_definition_list":[{"type":"DAG","name":"918baa8a_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"vm","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"918baa8a_dag","kind":"app_task"},"variable_list":[]},"critical":false},{"type":"system","name":"action_delete","description":"System action for deleting an application. Deletes created VMs as well","runbook":{"name":"ed8da465_runbook","description":"","task_definition_list":[{"type":"DAG","name":"91ba3824_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"vm","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"91ba3824_dag","kind":"app_task"},"variable_list":[]},"critical":false},{"type":"system","name":"action_start","description":"System action for starting an application","runbook":{"name":"8d96bbd0_runbook","description":"","task_definition_list":[{"type":"DAG","name":"e874d219_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"vm","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"e874d219_dag","kind":"app_task"},"variable_list":[]},"critical":false},{"type":"system","name":"action_stop","description":"System action for stopping an application","runbook":{"name":"8ad82719_runbook","description":"","task_definition_list":[{"type":"DAG","name":"68801fd1_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"vm","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"68801fd1_dag","kind":"app_task"},"variable_list":[]},"critical":false},{"type":"system","name":"action_restart","description":"System action for restarting an application","runbook":{"name":"9ce723f5_runbook","description":"","task_definition_list":[{"type":"DAG","name":"79e38243_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"vm","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"79e38243_dag","kind":"app_task"},"variable_list":[]},"critical":false}],"depends_on_list":[],"port_list":[],"singleton":false,"tier":""}],"published_service_definition_list":[],"substrate_definition_list":[{"type":"AHV_VM","name":"demo_vm","description":"","variable_list":[],"action_list":[{"type":"fragment","name":"pre_action_create","description":"","runbook":{"name":"554a0a25_runbook","description":"","task_definition_list":[{"type":"DAG","name":"e72ab3e7_dag","description":"","attrs":{"type":"","edges":[{"type":"","from_task_reference":{"name":"fetch_vm_name","kind":"app_task"},"to_task_reference":{"name":"set_ip_address","kind":"app_task"},"edge_type":"user_defined"}]},"child_tasks_local_reference_list":[{"name":"fetch_vm_name","kind":"app_task"},{"name":"set_ip_address","kind":"app_task"}],"variable_list":[],"target_any_local_reference":{"name":"demo_vm","kind":"app_substrate"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"SET_VARIABLE","name":"fetch_vm_name","description":"","attrs":{"type":"","script":"#script\n\n# Append static 's' which stands for server at the beginning to the VM\nvm_name = \"s\"\n\n# Append Application Profile to the VM\nserver_profile = \"@@{server_profile}@@\"\nif server_profile.lower() == \"appliance\":\n  vm_name += \"a\"\nelif server_profile.lower() == \"windows\":\n  vm_name += \"w\"\nelif server_profile.lower() == \"linux\":\n  vm_name += \"l\"\n\n# Append static 'pc' which stands for Private Cloud to the VM\nvm_name += \"pc\"\n\n# Append static 'qnb' identifier\nvm_name += \"qnb\"\n\n# Append static environment variable to the VM\nvar_environment = \"@@{var_environment}@@\"\nvm_name += var_environment\n\n# Determine VM index based on array index for counter logic\nvar_array_index = @@{calm_array_index}@@\nif var_array_index%2 == 0:\n    vm_index = \"1\"\nelse:\n    vm_index = \"2\"\n\n# Fetch existing VMs based on suffix\npc_ip = \"@@{pc_ip}@@\"\npc_user = \"@@{pc_username}@@\"\npc_pass = \"@@{pc_password}@@\"\n\n# Construct API URL and Headers\napi_url = \"https:\/\/{}:9440\/api\/vmm\/v4.0\/ahv\/config\/vms?$filter=startswith(name,'{}{}')&$select=name\".format(pc_ip,vm_name,vm_index)\nget_headers = {'Content-Type': 'application\/json',  'Accept':'application\/json'}\n\n# Fetch VM Data and ETag\nr = urlreq(api_url, verb='GET', headers=get_headers, verify=False, auth=\"BASIC\", user=pc_user, passwd=pc_pass)\nif r.ok:\n    resp = json.loads(r.content)\n    print(resp)\n    if resp['metadata']['totalAvailableResults'] == 0:\n      vm_suffix = 0\n    else:\n      list_of_vms = [item['name'] for item in resp['data']]\n      list_of_vms.sort()\n      vm_suffix = int(list_of_vms[-1][-2:])\n    vm_count = (int(vm_index) * 100) + int(vm_suffix) + (int(var_array_index)\/\/2+1)\nelse:\n    print(\"Get request failed\", r.content)\n    exit(1)\n\nprint(\"vm_name = \" + str(vm_name) + str(vm_count))\n","script_type":"static_py3","exit_status":[],"eval_scope":"local","eval_variables":["vm_name"]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"demo_vm","kind":"app_substrate"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"SET_VARIABLE","name":"set_ip_address","description":"","attrs":{"type":"","script":"### Set IP address\nip_address_list = \"@@{ip_address_list}@@\"\ncalm_array_index = @@{calm_array_index}@@\n# Fetch IP Address\nip_address = ip_address_list.split(',')[calm_array_index].strip()\nprint(\"ip_address = \" + ip_address)\n","script_type":"static_py3","exit_status":[],"eval_scope":"local","eval_variables":["ip_address"]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"demo_vm","kind":"app_substrate"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"e72ab3e7_dag","kind":"app_task"},"variable_list":[]},"critical":false},{"type":"fragment","name":"post_action_create","description":"","runbook":{"name":"33d569a9_runbook","description":"","task_definition_list":[{"type":"DAG","name":"c0717065_dag","description":"","attrs":{"type":"","edges":[{"type":"","from_task_reference":{"name":"fetch_variables","kind":"app_task"},"to_task_reference":{"name":"update_cpu","kind":"app_task"},"edge_type":"user_defined"},{"type":"","from_task_reference":{"name":"power_on","kind":"app_task"},"to_task_reference":{"name":"Wait_before_running_installation","kind":"app_task"},"edge_type":"user_defined"},{"type":"","from_task_reference":{"name":"update_cpu","kind":"app_task"},"to_task_reference":{"name":"power_on","kind":"app_task"},"edge_type":"user_defined"}]},"child_tasks_local_reference_list":[{"name":"fetch_variables","kind":"app_task"},{"name":"update_cpu","kind":"app_task"},{"name":"power_on","kind":"app_task"},{"name":"Wait_before_running_installation","kind":"app_task"}],"variable_list":[],"target_any_local_reference":{"name":"demo_vm","kind":"app_substrate"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"SET_VARIABLE","name":"fetch_variables","description":"","attrs":{"type":"","script":"vm_tshirt_complete = \"@@{vm_size}@@\"\nvm_tshirt = vm_tshirt_complete.split(' ')[0]\nVM_SIZES = {\n    'Small': {'cpu': 2},\n    'Medium': {'cpu': 4},\n    'Large': {'cpu': 6},\n    'XLarge': {'cpu': 8}\n}\nprint(\"CPU_COUNT = {}\".format(VM_SIZES[vm_tshirt]['cpu']))","script_type":"static_py3","exit_status":[],"eval_scope":"local","eval_variables":["CPU_COUNT"]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"demo_vm","kind":"app_substrate"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"update_cpu","description":"","attrs":{"type":"","script":"#script\nvm_uuid = \"@@{id}@@\"\ncpu_count = \"@@{CPU_COUNT}@@\"\npc_ip = \"@@{pc_ip}@@\"\npc_user = \"@@{pc_username}@@\"\npc_pass = \"@@{pc_password}@@\"\n\n# Construct API URL and Headers\napi_url = \"https:\/\/{}:9440\/api\/vmm\/v4.0.b1\/ahv\/config\/vms\/{}\".format(pc_ip,vm_uuid)\nget_headers = {'Content-Type': 'application\/json',  'Accept':'application\/json'}\n\n# Fetch VM Data and ETag\nr = urlreq(api_url, verb='GET', headers=get_headers, verify=False, auth=\"BASIC\", user=pc_user, passwd=pc_pass)\nif r.ok:\n    resp = json.loads(r.content)\n    etag = r.headers['Etag']\n    print(\"Fetched VM Data and ETag\")\nelse:\n    print(\"Get request failed\", r.content)\n    exit(1)\n\n# Update CPU\nnew_uuid = uuid.uuid1()\nresp['data']['numCoresPerSocket'] = int(cpu_count)\nresp['data']['numSockets'] = 1\n\nput_headers = {'Content-Type': 'application\/json', 'If-Match': etag, 'NTNX-Request-Id': str(new_uuid), 'Accept':'application\/json'}\nr = urlreq(api_url, verb='PUT', params=json.dumps(resp['data']), headers=put_headers, verify=False, auth=\"BASIC\", user=pc_user, passwd=pc_pass)\nif r.ok:\n    resp = json.loads(r.content)\n    print(\"CPU updated to : {} cores\".format(cpu_count))\nelse:\n    print(\"PUT Call failed\", r.content)\n    exit(1)\n","script_type":"static_py3","command_line_args":"","exit_status":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"demo_vm","kind":"app_substrate"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"CALL_RUNBOOK","name":"power_on","description":"","attrs":{"type":"CALL_RUNBOOK","runbook_reference":{"name":"SYS_GEN__substrate__demo_vm__action_poweron__runbook","kind":"app_runbook"},"inarg_list":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"demo_vm","kind":"app_substrate"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"DELAY","name":"Wait_before_running_installation","description":"","attrs":{"type":"","interval_secs":30},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"demo_vm","kind":"app_substrate"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"c0717065_dag","kind":"app_task"},"variable_list":[]},"critical":false},{"type":"fragment","name":"post_action_delete","description":"","runbook":{"name":"1a30cba8_runbook","description":"","task_definition_list":[{"type":"DAG","name":"e94a0e89_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"demo_vm","kind":"app_substrate"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"e94a0e89_dag","kind":"app_task"},"variable_list":[]},"critical":false}],"editables":{"create_spec":{"categories":true,"resources":{"disk_list":{"0":{"data_source_reference":true,"disk_size_mib":true}},"boot_config":{"boot_device":true}}}},"create_spec":{"type":"","name":"@@{vm_name}@@","availability_zone_reference":null,"backup_policy":null,"cluster_reference":{"type":"","kind":"cluster","name":"PHX-POC176","uuid":"000647d0-2364-3de8-0000-00000002acd1"},"resources":{"type":"","nic_list":[{"type":"","nic_type":"NORMAL_NIC","subnet_reference":{"type":"","kind":"subnet","name":"","uuid":"3c18a3df-bd09-445f-92ec-076ad613a1b3"},"network_function_nic_type":"INGRESS","mac_address":"","ip_endpoint_list":[{"type":"ASSIGNED","ip":"@@{ip_address_list}@@"}],"network_function_chain_reference":null,"vpc_reference":null}],"power_state":"OFF","guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":2,"memory_size_mib":4096,"gpu_list":[],"parent_reference":null,"hardware_clock_timezone":"","account_uuid":"f1315bf3-98c4-4005-8b7e-f75d6571ff0e","guest_customization":{"type":"","cloud_init":{"type":"","meta_data":"","user_data":"#cloud-config\nssh_pwauth: true\nhostname: \"@@{vm_name}@@\"\nusers:\n  - name: qnbuser\n    lock_passwd: false\n    ssh_pwauth: True\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']\nchpasswd:\n  list: |\n    qnbuser:Qnb@1234\n  expire: False\nruncmd:\n  - nmcli connection migrate\n  - nmcli con down \"System eth0\"\n  - nmcli con del \"System eth0\"\n  - >-\n     nmcli con add con-name \"System eth0\" ifname eth0 type ethernet \n     ip4 @@{ip_address}@@\/@@{ip_prefix}@@ gw4 @@{ip_gateway}@@ \n     ipv4.dns \"@@{primary_ip_dns_server}@@\"  \n  - nmcli con up \"System eth0\"\n  - nmcli general reload\n  - nmcli connection reload"},"sysprep":null},"boot_config":{"type":"","boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"mac_address":"","boot_type":"UEFI"},"vtpm_config":null,"disk_list":[{"type":"","data_source_reference":{"type":"","kind":"image","name":"rhel-8.10-x86_64-kvm.qcow2","uuid":"0843d723-b4c7-45c4-a4c6-5da01c125a43"},"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"},"disk_size_mib":102400}],"serial_port_list":[]},"categories":{"Environment":"Testing","OSType":"Linux"}},"os_type":"Linux","readiness_probe":{"login_credential_local_reference":{"name":"ans_script_creds","kind":"app_credential"},"connection_type":"SSH","connection_port":22,"delay_secs":"60","retries":"5","address":"@@{ip_address}@@","disable_readiness_probe":false,"connection_protocol":""}}],"package_definition_list":[{"type":"DEB","name":"post_configuration","description":"","variable_list":[],"action_list":[],"service_local_reference_list":[{"name":"vm","kind":"app_service"}],"version":"","options":{"type":"","install_runbook":{"name":"77624941_runbook","description":"","task_definition_list":[{"type":"DAG","name":"e71022bd_dag","description":"","attrs":{"type":"","edges":[{"type":"","from_task_reference":{"name":"package_installation","kind":"app_task"},"to_task_reference":{"name":"domain_join","kind":"app_task"},"edge_type":"user_defined"},{"type":"","from_task_reference":{"name":"subscription_registration","kind":"app_task"},"to_task_reference":{"name":"package_installation","kind":"app_task"},"edge_type":"user_defined"}]},"child_tasks_local_reference_list":[{"name":"package_installation","kind":"app_task"},{"name":"subscription_registration","kind":"app_task"},{"name":"domain_join","kind":"app_task"}],"variable_list":[],"target_any_local_reference":{"name":"post_configuration","kind":"app_package"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"package_installation","description":"","attrs":{"type":"","script":"#!\/bin\/bash\necho \"Installing Active Directory management tools...\"\n\n# The -y flag ensures non-interactive installation\nsudo yum install -y realmd sssd adcli samba-common-tools oddjob oddjob-mkhomedir\n\nif [ $? -eq 0 ]; then\n    echo \"SUCCESS: Packages installed.\"\nelse\n    echo \"ERROR: Package installation failed.\"\n    exit 1\nfi","script_type":"sh","command_line_args":"","exit_status":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"vm","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"subscription_registration","description":"","attrs":{"type":"","script":"#!\/bin\/bash\n\n# Subscription Manager Registration Script for RHEL 8\n# This script registers the system with Red Hat Subscription Manager and enables repositories\n\n# Get variables from Calm (if using variables, otherwise hardcoded for now)\nSUBSCRIPTION_USERNAME=\"Mukesh.sahoo\"\nSUBSCRIPTION_PASSWORD=\"Superman@12345\"\n\nMAX_RETRIES=5\nRETRY_DELAY=30\n\n# Function to perform subscription registration and repo enablement\nperform_registration_and_repos() {\n    local attempt=$1\n    echo \"Registration and repository enablement attempt $attempt of $MAX_RETRIES\"\n    \n    # Wait a bit to ensure network is stable\n    sleep 5\n    \n    # Step 1: Register without auto-attach (|| true ensures we continue even if connection error occurs)\n    echo \"Step 1: Registering system with Red Hat Subscription Manager...\"\n    register_output=$(sudo subscription-manager register \\\n        --username \"$SUBSCRIPTION_USERNAME\" \\\n        --password \"$SUBSCRIPTION_PASSWORD\" 2>&1 || true)\n    register_exit_code=$?\n    \n    echo \"Registration command output:\"\n    echo \"$register_output\"\n    echo \"\"\n    \n    # Check if registration was successful (even if connection error occurred afterward)\n    registration_success=false\n    if echo \"$register_output\" | grep -qi \"system has been registered\\|has been registered with ID\"; then\n        echo \"SUCCESS: System registration confirmed - 'has been registered' message found\"\n        registration_success=true\n        \n        # Check for connection error after registration (non-fatal)\n        if echo \"$register_output\" | grep -qi \"Connection error\\|Connection reset\"; then\n            echo \"WARNING: Connection error occurred after successful registration (non-fatal)\"\n            echo \"WARNING: This is expected on first attempt - registration was successful\"\n        fi\n    elif echo \"$register_output\" | grep -qi \"already registered\\|This system is already registered\"; then\n        echo \"INFO: System is already registered with Red Hat\"\n        registration_success=true\n    else\n        # Check for authentication errors\n        if echo \"$register_output\" | grep -qi \"Invalid username\\|Invalid password\\|Authentication failed\"; then\n            echo \"ERROR: Authentication failed - check username\/password\"\n            return 1\n        fi\n        \n        # If no success message and not already registered, it's a failure\n        if [ $register_exit_code -ne 0 ] && ! echo \"$register_output\" | grep -qi \"has been registered\\|already registered\"; then\n            echo \"ERROR: Registration failed - no success message found\"\n            return 1\n        fi\n    fi\n    \n    # If registration succeeded (or system already registered), proceed with repo enablement\n    if [ \"$registration_success\" = true ]; then\n        echo \"\"\n        echo \"Step 2: Enabling RHEL 8 repositories...\"\n        \n        # Wait a moment for registration to fully propagate\n        sleep 3\n        \n        # Enable repositories\n        repo_output=$(sudo subscription-manager repos \\\n            --enable=rhel-8-for-x86_64-baseos-rpms \\\n            --enable=rhel-8-for-x86_64-appstream-rpms 2>&1)\n        repo_exit_code=$?\n        \n        echo \"Repository enablement command output:\"\n        echo \"$repo_output\"\n        echo \"\"\n        \n        # Check if repo enablement was successful\n        repo_enabled=false\n        if [ $repo_exit_code -eq 0 ]; then\n            echo \"SUCCESS: Repositories enabled successfully\"\n            repo_enabled=true\n        else\n            # Check if repos are already enabled\n            if echo \"$repo_output\" | grep -qi \"already enabled\\|already in use\"; then\n                echo \"INFO: Repositories appear to be already enabled\"\n                repo_enabled=true\n            else\n                echo \"WARNING: Repository enablement had issues, but continuing...\"\n                # Still continue if registration worked, as repos might be available via SCA\n                repo_enabled=true\n            fi\n        fi\n        \n        # Step 3: Clean yum cache and rebuild\n        if [ \"$repo_enabled\" = true ]; then\n            echo \"\"\n            echo \"Step 3: Cleaning yum cache...\"\n            if sudo yum clean all 2>&1; then\n                echo \"SUCCESS: Yum cache cleaned successfully\"\n            else\n                echo \"WARNING: Yum cache clean had issues, but continuing...\"\n            fi\n            \n            echo \"\"\n            echo \"Step 4: Rebuilding yum cache...\"\n            if sudo yum makecache 2>&1; then\n                echo \"SUCCESS: Yum cache rebuilt successfully\"\n                return 0\n            else\n                echo \"WARNING: Yum makecache had issues, but continuing...\"\n                # Still return success as repositories are enabled\n                return 0\n            fi\n        else\n            return 1\n        fi\n    else\n        return 1\n    fi\n}\n\n# Main execution\necho \"============================================================\"\necho \"Red Hat Subscription Manager Registration\"\necho \"============================================================\"\necho \"Username: $SUBSCRIPTION_USERNAME\"\necho \"Max Retries: $MAX_RETRIES\"\necho \"Retry Delay: $RETRY_DELAY seconds\"\necho \"============================================================\"\necho \"\"\n\n# Check if already registered and repos enabled\nif sudo subscription-manager status > \/dev\/null 2>&1; then\n    echo \"System appears to be already registered with Red Hat\"\n    echo \"\"\n    echo \"Checking repository status...\"\n    if sudo subscription-manager repos --list-enabled | grep -q \"rhel-8-for-x86_64-baseos-rpms\\|rhel-8-for-x86_64-appstream-rpms\"; then\n        echo \"Repositories are already enabled\"\n        echo \"\"\n        echo \"Cleaning and rebuilding yum cache...\"\n        sudo yum clean all\n        sudo yum makecache\n        echo \"\"\n        sudo subscription-manager status\n        exit 0\n    else\n        echo \"System is registered but repositories need to be enabled\"\n        echo \"Enabling repositories...\"\n        sudo subscription-manager repos \\\n            --enable=rhel-8-for-x86_64-baseos-rpms \\\n            --enable=rhel-8-for-x86_64-appstream-rpms\n        echo \"\"\n        echo \"Cleaning and rebuilding yum cache...\"\n        sudo yum clean all\n        sudo yum makecache\n        exit 0\n    fi\nfi\n\n# Retry logic\nfor attempt in $(seq 1 $MAX_RETRIES); do\n    echo \"=== Attempt $attempt ===\"\n    \n    # Perform registration and repo enablement\n    if perform_registration_and_repos $attempt; then\n        echo \"\"\n        echo \"============================================================\"\n        echo \"Registration and repository enablement successful on attempt $attempt\"\n        echo \"============================================================\"\n        \n        # Verify registration and cache\n        echo \"\"\n        echo \"Verifying registration status...\"\n        if sudo subscription-manager status; then\n            echo \"\"\n            echo \"Verifying enabled repositories...\"\n            sudo subscription-manager repos --list-enabled | grep -E \"rhel-8-for-x86_64-baseos-rpms|rhel-8-for-x86_64-appstream-rpms\" || echo \"Note: Repositories may be available via SCA\"\n            echo \"\"\n            echo \"Verifying yum cache...\"\n            echo \"Yum cache has been cleaned and rebuilt as part of the process\"\n            echo \"\"\n            echo \"============================================================\"\n            echo \"Process completed successfully\"\n            echo \"============================================================\"\n            exit 0\n        else\n            echo \"WARNING: Status check had issues, but registration was confirmed\"\n            exit 0\n        fi\n    else\n        if [ $attempt -lt $MAX_RETRIES ]; then\n            echo \"Attempt $attempt failed. Waiting $RETRY_DELAY seconds before retry...\"\n            sleep $RETRY_DELAY\n        else\n            echo \"All $MAX_RETRIES attempts failed. Registration unsuccessful.\"\n            exit 1\n        fi\n    fi\n    echo \"\"\ndone","script_type":"sh","command_line_args":"","exit_status":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"vm","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]},{"type":"EXEC","name":"domain_join","description":"","attrs":{"type":"","script":"#!\/bin\/bash\n\n# Domain Join Script for RHEL 8 to Active Directory\n# This script joins the Linux system to an Active Directory domain using realm\n\n# Get variables from Calm\nAD_DOMAIN_NAME=\"@@{ad_domain_name}@@\"\nAD_JOIN_USERNAME=\"@@{ad_join_username}@@\"\nAD_JOIN_PASSWORD=\"@@{ad_join_password}@@\"\n\nMAX_RETRIES=10\nRETRY_DELAY=20\n\n# Function to perform domain join\nperform_domain_join() {\n    local attempt=$1\n    echo \"Domain join attempt $attempt of $MAX_RETRIES\"\n    \n    # Execute realm join with password piped via stdin\n    output=$(echo \"$AD_JOIN_PASSWORD\" | sudo realm join -U \"$AD_JOIN_USERNAME\" \"$AD_DOMAIN_NAME\" 2>&1)\n    exit_code=$?\n    \n    echo \"Command output: $output\"\n    \n    # Check if the output contains \"Password for\" (password prompt detected)\n    if echo \"$output\" | grep -q \"Password for\"; then\n        echo \"SUCCESS: Password prompt detected - domain join initiated successfully\"\n        return 0\n    fi\n    \n    # Check exit code as primary validation\n    if [ $exit_code -eq 0 ]; then\n        echo \"SUCCESS: Domain join completed successfully (exit code 0)\"\n        return 0\n    else\n        echo \"FAILED: Domain join failed with exit code $exit_code\"\n        return 1\n    fi\n}\n\n# Main execution\necho \"============================================================\"\necho \"Domain Join Configuration\"\necho \"============================================================\"\necho \"Domain Name: $AD_DOMAIN_NAME\"\necho \"Join Username: $AD_JOIN_USERNAME\"\necho \"Max Retries: $MAX_RETRIES\"\necho \"============================================================\"\necho \"\"\n\n# Retry logic\nfor attempt in $(seq 1 $MAX_RETRIES); do\n    echo \"=== Attempt $attempt ===\"\n    if perform_domain_join $attempt; then\n        echo \"Domain join successful on attempt $attempt\"\n        \n        # Verify domain join\n        echo \"\"\n        echo \"Verifying domain join...\"\n        if realm_output=$(sudo realm list 2>&1); then\n            echo \"$realm_output\"\n            if echo \"$realm_output\" | grep -qi \"$AD_DOMAIN_NAME\"; then\n                echo \"Domain join verified successfully!\"\n            else\n                echo \"Warning: Domain not found in realm list\"\n            fi\n        else\n            echo \"Could not verify domain join status\"\n        fi\n        \n        echo \"\"\n        echo \"============================================================\"\n        echo \"Domain join process completed\"\n        echo \"============================================================\"\n        exit 0\n    else\n        if [ $attempt -lt $MAX_RETRIES ]; then\n            echo \"Attempt $attempt failed. Waiting $RETRY_DELAY seconds before retry...\"\n            sleep $RETRY_DELAY\n        else\n            echo \"All $MAX_RETRIES attempts failed. Domain join unsuccessful.\"\n            exit 1\n        fi\n    fi\n    echo \"\"\ndone\n","script_type":"sh","command_line_args":"","exit_status":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"vm","kind":"app_service"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"e71022bd_dag","kind":"app_task"},"variable_list":[]},"uninstall_runbook":{"name":"420573c0_runbook","description":"","task_definition_list":[{"type":"DAG","name":"e1001289_dag","description":"","attrs":{"type":"","edges":[]},"child_tasks_local_reference_list":[],"variable_list":[],"target_any_local_reference":{"name":"post_configuration","kind":"app_package"},"timeout_secs":"0","retries":"0","inherit_target":false,"status_map_list":[]}],"main_task_local_reference":{"name":"e1001289_dag","kind":"app_task"},"variable_list":[]},"upgrade_runbook":{}}}],"app_profile_list":[{"name":"Default","description":"","variable_list":[{"type":"EXEC_LOCAL","name":"var_vlan","description":"Nutanix Subnet to assigned to the VMs","regex":{"value":"^.*$","should_validate":false},"options":{"type":"EXEC","attrs":{"type":"EXEC","script":"# Fetch all VLANs\/Subnets\npc_ip = \"@@{pc_ip}@@\"\ncalm_username = \"@@{pc_username}@@\"\ncalm_password = \"@@{pc_password}@@\"\n\n# Construct API URL to fetch all subnets (no filter)\napi_url = \"https:\/\/{}:9440\/api\/networking\/v4.0\/config\/subnets\".format(pc_ip)\nget_headers = {'Content-Type': 'application\/json',  'Accept':'application\/json'}\n\n# Fetch all Subnets\nr = urlreq(api_url, verb='GET', headers=get_headers, verify=False, auth=\"BASIC\", user=calm_username, passwd=calm_password)\nif r.ok:\n    resp = json.loads(r.content)\n    subnet_list = []\n    for net in resp['data']:\n      subnet_list.append(net['name'])\nelse:\n    print(\"Get request failed\", r.content)\n    exit(1)\n\n# Remove duplicates and clean the output\nclean_subnet_list = list(set(subnet_list))\nprint(\",\".join(clean_subnet_list))","script_type":"static_py3","command_line_args":"","exit_status":[]}},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"STRING","label":"Nutanix Subnet","attrs":{"type":""},"editables":{"value":true},"value":""},{"type":"LOCAL","name":"vm_count","description":"Note: Make sure the number of VMs is matching the number of comma-separated IPs being provided","regex":{"value":"^[\\d]*$","should_validate":false},"options":{"type":"PREDEFINED","choices":[]},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"INT","label":"Number of VMs to be created","attrs":{"type":""},"editables":{"value":true},"value":""},{"type":"LOCAL","name":"pc_ip","description":"","options":{"type":"PREDEFINED","choices":[]},"is_hidden":true,"is_mandatory":false,"data_type":"BASE","val_type":"STRING","label":"","attrs":{"type":""},"editables":{"value":false},"value":"10.38.176.7"},{"type":"LOCAL","name":"pc_username","description":"","options":{"type":"PREDEFINED","choices":[]},"is_hidden":true,"is_mandatory":false,"data_type":"BASE","val_type":"STRING","label":"","attrs":{"type":"LOCAL"},"editables":{"value":false},"value":"admin"},{"type":"LOCAL","name":"ip_address_list","description":"Provide the list of IP Address as a comma-separate list of values (ex: 10.38.176.39, 10.38.176.125)","options":{"type":"PREDEFINED","choices":[]},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"STRING","label":"List of IP Addresses","attrs":{"type":""},"editables":{"value":true},"value":""},{"type":"LOCAL","name":"var_environment","description":"","regex":{"value":"^.*$","should_validate":false},"options":{"type":"PREDEFINED","choices":[]},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"STRING","label":"","attrs":{"type":"LOCAL"},"value":"np"},{"type":"LOCAL","name":"vm_size","description":"","options":{"type":"PREDEFINED","choices":["Small (CPU:2)","Medium (CPU:4)","Large (CPU:6)","XLarge (CPU:8)"]},"is_hidden":false,"is_mandatory":true,"data_type":"BASE","val_type":"STRING","label":"VM Flavor","attrs":{"type":"LOCAL"},"editables":{"value":true},"value":"Small (CPU:2)"},{"type":"LOCAL","name":"server_profile","description":"","regex":{"value":"^.*$","should_validate":false},"options":{"type":"PREDEFINED","choices":["Appliance","Windows","Linux"]},"is_hidden":false,"is_mandatory":false,"data_type":"BASE","val_type":"STRING","label":"Server Profile","attrs":{"type":"LOCAL"},"editables":{"value":true},"value":"Appliance"},{"type":"LOCAL","name":"application_type","description":"","options":{"type":"PREDEFINED","choices":["Database","Application"]},"is_hidden":false,"is_mandatory":false,"data_type":"BASE","val_type":"STRING","label":"Application Type","attrs":{"type":"LOCAL"},"editables":{"value":true},"value":"Database"},{"type":"SECRET","name":"pc_password","description":"","regex":{"value":"^.*$","should_validate":false},"options":{"type":"PREDEFINED","choices":[]},"is_hidden":true,"is_mandatory":false,"data_type":"BASE","val_type":"STRING","label":"","attrs":{"type":"SECRET","is_secret_modified":false,"secret_reference":{}},"editables":{"value":false},"value":"o9p8QGeyPqR3WFpL4he0WHdw1+w\/qDHJ0S\/iCurX1RM\/XNT8hVK7gJM1tA==:utf-8"},{"type":"LOCAL","name":"ip_gateway","description":"","options":{"type":"PREDEFINED","choices":[]},"is_hidden":true,"is_mandatory":false,"data_type":"BASE","val_type":"STRING","label":"","attrs":{"type":""},"editables":{"value":false},"value":"10.38.176.1"},{"type":"LOCAL","name":"ip_prefix","description":"","options":{"type":"PREDEFINED","choices":[]},"is_hidden":true,"is_mandatory":false,"data_type":"BASE","val_type":"STRING","label":"","attrs":{"type":""},"editables":{"value":false},"value":"25"},{"type":"LOCAL","name":"primary_ip_dns_server","description":"","options":{"type":"PREDEFINED","choices":[]},"is_hidden":true,"is_mandatory":false,"data_type":"BASE","val_type":"STRING","label":"","attrs":{"type":""},"editables":{"value":false},"value":"10.38.176.6"},{"type":"LOCAL","name":"ad_domain_name","description":"","options":{"type":"PREDEFINED","choices":[]},"is_hidden":true,"is_mandatory":false,"data_type":"BASE","val_type":"STRING","label":"","attrs":{"type":""},"editables":{"value":false},"value":"ntnxlab.local"},{"type":"LOCAL","name":"ad_join_username","description":"","options":{"type":"PREDEFINED","choices":[]},"is_hidden":true,"is_mandatory":false,"data_type":"BASE","val_type":"STRING","label":"","attrs":{"type":""},"editables":{"value":false},"value":"Administrator"},{"type":"SECRET","name":"ad_join_password","description":"","options":{"type":"PREDEFINED","choices":[]},"is_hidden":true,"is_mandatory":false,"data_type":"BASE","val_type":"STRING","label":"","attrs":{"type":"SECRET","is_secret_modified":false,"secret_reference":{}},"editables":{"value":false},"value":"33grIJYCgeOeEzvqHZWBxwwrE9t\/K9i6rpQw+6QL6dWYTtHv3eECNZ\/OoQ==:utf-8"}],"action_list":[],"deployment_create_list":[{"type":"GREENFIELD","name":"deployment_fc37c968","description":"","variable_list":[],"action_list":[],"depends_on_list":[],"min_replicas":"@@{vm_count}@@","max_replicas":"@@{vm_count}@@","default_replicas":"@@{vm_count}@@","package_local_reference_list":[{"name":"post_configuration","kind":"app_package"}],"substrate_local_reference":{"name":"demo_vm","kind":"app_substrate"},"published_service_local_reference_list":[]}],"snapshot_config_list":[],"restore_config_list":[],"environment_reference_list":[],"application_url":"","patch_list":[]}],"credential_definition_list":[{"type":"PASSWORD","name":"ans_script_creds","description":"","username":"qnbuser","secret":{"attrs":{"secret_reference":{},"is_secret_modified":true},"value":"+hxHCtr1yohtyX5RbhanzS\/rLPwAwuNekyUFlZ2gIbqVzkCW5jy1Xg==:utf-8"},"cred_class":"static"}],"default_credential_local_reference":{"name":"ans_script_creds","kind":"app_credential"},"type":"USER","client_attrs":{"deployment_fc37c968":{"x":497.9295742722012,"y":-515.9641540326854}},"global_variable_reference_list":[]}},"api_version":"3.0","product_version":"4.3.0","metadata":{"last_update_time":"1768342567243238","creation_time":"1768328177622849","spec_version":27,"name":"MultiVM-RHEL8","kind":"blueprint"},"contains_secrets":true}